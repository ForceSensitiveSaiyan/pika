# PIKA Production Docker Compose
#
# Uses pre-built image from GitHub Container Registry.
# For local development, use docker-compose.yml instead.

services:
  ollama:
    image: ollama/ollama:latest
    container_name: pika-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    environment:
      - OLLAMA_CONTEXT_LENGTH=4096
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  pika:
    image: ghcr.io/forcesensitivesaiyan/pika:latest
    container_name: pika-app
    ports:
      - "8000:8000"
    volumes:
      - ./documents:/app/documents
      - pika_data:/app/data
    environment:
      - DEBUG=false
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3.2:3b
      - OLLAMA_TIMEOUT=300
      - DOCUMENTS_DIR=/app/documents
      - CHROMA_PERSIST_DIR=/app/data/chroma
      - AUDIT_LOG_PATH=/app/data/audit.log
    depends_on:
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

volumes:
  ollama_models:
    name: pika_ollama_models
  pika_data:
    name: pika_data
