{% extends "base.html" %}

{% block title %}PIKA - Chat{% endblock %}

{% block content %}
<a href="/admin" class="admin-link">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
    Admin
</a>

<main class="chat-container">
    <div class="chat-messages" id="chat-messages">
        <div class="welcome-message">
            <h2>Welcome to PIKA</h2>
            <p>Ask questions about your indexed documents.</p>
            <p class="welcome-hint">Upload and index documents in the <a href="/admin">Admin</a> section.</p>
        </div>
    </div>

    <form class="chat-input-form" id="chat-form" onsubmit="sendQuestion(event)">
        <input
            type="text"
            class="chat-input"
            id="question-input"
            placeholder="Ask a question about your documents..."
            autocomplete="off"
        >
        <button type="submit" class="btn btn-send" id="send-btn">
            Send
        </button>
    </form>
</main>
{% endblock %}

{% block scripts %}
<script>
    // State
    let isLoading = false;

    // Send question
    async function sendQuestion(event) {
        event.preventDefault();

        const input = document.getElementById('question-input');
        const question = input.value.trim();

        if (!question || isLoading) return;

        input.value = '';
        isLoading = true;
        updateSendButton();

        // Add user message
        addMessage(question, 'user');

        // Add loading indicator
        const loadingId = addMessage('Thinking...', 'assistant', true);

        try {
            const response = await fetch('/api/v1/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'Query failed');
            }

            // Remove loading and add response
            removeMessage(loadingId);
            addAnswerMessage(result);

        } catch (error) {
            removeMessage(loadingId);
            addMessage('Error: ' + error.message, 'error');
        } finally {
            isLoading = false;
            updateSendButton();
        }
    }

    // Add a chat message
    function addMessage(content, type, isLoading = false) {
        const container = document.getElementById('chat-messages');
        const welcome = container.querySelector('.welcome-message');
        if (welcome) welcome.remove();

        const id = 'msg-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = `message message-${type}${isLoading ? ' loading' : ''}`;
        div.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        return id;
    }

    // Add answer with sources
    function addAnswerMessage(result) {
        const container = document.getElementById('chat-messages');

        const div = document.createElement('div');
        div.className = 'message message-assistant';

        let sourcesHtml = '';
        if (result.sources && result.sources.length > 0) {
            const uniqueSources = [...new Set(result.sources.map(s => s.filename))];
            sourcesHtml = `
                <div class="sources">
                    <span class="sources-label">Sources:</span>
                    ${uniqueSources.map(f => `<span class="source-tag">${escapeHtml(f)}</span>`).join('')}
                </div>
            `;
        }

        div.innerHTML = `
            <div class="message-content">
                <div class="answer-text">${escapeHtml(result.answer)}</div>
                ${sourcesHtml}
                <span class="confidence-badge confidence-${result.confidence}">${result.confidence}</span>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // Remove message by ID
    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    // Update send button state
    function updateSendButton() {
        const btn = document.getElementById('send-btn');
        btn.disabled = isLoading;
        btn.textContent = isLoading ? '...' : 'Send';
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
