{% extends "base.html" %}

{% block title %}PIKA - Chat{% endblock %}

{% block content %}
<!-- Header -->
<header class="header">
    <div class="header-left">
        <a href="/" class="logo">PIKA</a>
    </div>
    <a href="/admin" class="header-link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Admin
    </a>
</header>

<!-- Chat Layout -->
<div class="chat-layout">
    <div class="chat-messages" id="chat-messages">
        <div class="welcome" id="welcome">
            <svg class="welcome-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <h1 class="welcome-title">Ask anything about your documents</h1>
            <p class="welcome-text">
                Upload and index documents in the <a href="/admin">Admin</a> section, then ask questions here.
            </p>
        </div>
    </div>

    <div class="chat-input-container">
        <form class="chat-input-wrapper" id="chat-form" onsubmit="sendQuestion(event)">
            <input
                type="text"
                class="chat-input"
                id="question-input"
                placeholder="Ask a question..."
                autocomplete="off"
            >
            <button type="submit" class="btn btn-primary chat-send-btn" id="send-btn">
                Send
            </button>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
    let isLoading = false;
    let messageCounter = 0;

    async function sendQuestion(event) {
        event.preventDefault();

        const input = document.getElementById('question-input');
        const question = input.value.trim();

        if (!question || isLoading) return;

        input.value = '';
        isLoading = true;
        updateSendButton();

        // Remove welcome
        const welcome = document.getElementById('welcome');
        if (welcome) welcome.remove();

        // Add user message
        addMessage(question, 'user');

        // Add loading message
        const loadingId = addMessage('Thinking', 'assistant', true);

        try {
            const response = await fetch('/api/v1/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'Query failed');
            }

            removeMessage(loadingId);
            addAnswerMessage(result);

        } catch (error) {
            removeMessage(loadingId);
            addMessage('Error: ' + error.message, 'error');
        } finally {
            isLoading = false;
            updateSendButton();
        }
    }

    function addMessage(content, type, isLoading = false) {
        const container = document.getElementById('chat-messages');
        const id = 'msg-' + (messageCounter++);

        const div = document.createElement('div');
        div.id = id;
        div.className = `message message-${type}${isLoading ? ' message-loading' : ''}`;

        const loadingClass = isLoading ? ' loading-dots' : '';
        div.innerHTML = `
            <div class="message-bubble">
                <div class="message-content${loadingClass}">${escapeHtml(content)}</div>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        return id;
    }

    function addAnswerMessage(result) {
        const container = document.getElementById('chat-messages');

        const div = document.createElement('div');
        div.className = 'message message-assistant';

        let sourcesHtml = '';
        if (result.sources && result.sources.length > 0) {
            const uniqueSources = [...new Set(result.sources.map(s => s.filename))];
            sourcesHtml = `
                <div class="message-sources">
                    <span class="source-label">Sources</span>
                    ${uniqueSources.map(f => `<span class="source-pill">${escapeHtml(f)}</span>`).join('')}
                </div>
            `;
        }

        const confidenceHtml = `
            <div class="message-footer">
                <span class="confidence confidence-${result.confidence}">
                    <span class="confidence-dot"></span>
                    ${result.confidence}
                </span>
            </div>
        `;

        div.innerHTML = `
            <div class="message-bubble">
                <div class="message-content">${escapeHtml(result.answer)}</div>
                ${sourcesHtml}
                ${confidenceHtml}
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function updateSendButton() {
        const btn = document.getElementById('send-btn');
        btn.disabled = isLoading;
        btn.innerHTML = isLoading ? '<span class="spinner"></span>' : 'Send';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Allow Enter to submit (Shift+Enter for new line would need textarea)
    document.getElementById('question-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }
    });
</script>
{% endblock %}
