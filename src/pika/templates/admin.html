{% extends "base.html" %}

{% block title %}PIKA - Admin{% endblock %}

{% block content %}
<!-- Header -->
<header class="header">
    <div class="header-left">
        <a href="/" class="logo">PIKA</a>
        <span class="header-divider">/</span>
        <span class="header-title">Admin</span>
    </div>
    <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </button>
        <a href="/admin/logs" class="header-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Logs
        </a>
        {% if auth_enabled %}
        <a href="/admin/logout" class="header-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </a>
        {% endif %}
        <a href="/" class="header-link header-link-primary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Chat
        </a>
    </div>
</header>

<!-- Admin Content -->
<div class="admin-container">
    <div class="admin-content">
        <!-- Models Section -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div class="section-title-group">
                    <h2 class="section-title">Models</h2>
                    <p class="section-desc">Manage your AI models</p>
                </div>
            </div>

            <div class="section-body">
                <!-- Current Model -->
                <div class="current-model-card" id="current-model">
                    <div class="current-model-info">
                        <span class="current-model-label">Active Model</span>
                        <span class="current-model-name" id="current-model-name">Loading...</span>
                    </div>
                    <span class="status-badge status-active" id="model-status-badge">
                        <span class="status-dot"></span>
                        <span id="model-status-text">Running</span>
                    </span>
                </div>

                <!-- Switch Model -->
                <div class="form-section">
                    <label class="form-label">Switch Model</label>
                    <div class="input-group">
                        <select id="model-select" class="form-select">
                            <option value="">Loading models...</option>
                        </select>
                        <button class="btn btn-primary" id="switch-model-btn" onclick="switchModel()">
                            Switch
                        </button>
                    </div>
                </div>

                <!-- Pull New Model -->
                <div class="form-section">
                    <label class="form-label">Pull New Model</label>
                    <div class="input-group">
                        <input
                            type="text"
                            id="model-name"
                            class="form-input"
                            placeholder="e.g., llama3.1:8b"
                        >
                        <button class="btn btn-secondary" id="pull-model-btn" onclick="pullModel()">
                            Pull
                        </button>
                    </div>
                    <p class="form-hint">
                        Browse models at <a href="https://ollama.com/library" target="_blank">ollama.com/library</a>
                    </p>
                </div>

                <!-- Pull Progress -->
                <div class="progress-card" id="pull-progress">
                    <div class="progress-header">
                        <p class="progress-text" id="progress-text">Starting download...</p>
                        <button class="btn btn-danger btn-sm" id="cancel-pull-btn" onclick="cancelPull()">Cancel</button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Documents Section -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <div class="section-title-group">
                    <h2 class="section-title">Documents</h2>
                    <p class="section-desc">Upload and manage your knowledge base</p>
                </div>
                <button class="btn btn-primary" id="refresh-index-btn" onclick="refreshIndex()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh Index
                </button>
            </div>

            <div class="section-body">
                <!-- Upload Zone -->
                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="file-input" multiple accept=".pdf,.docx,.txt,.md" hidden>
                    <div class="upload-icon-wrapper">
                        <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <p class="upload-text">Drop files here or click to browse</p>
                    <p class="upload-hint">Supports PDF, DOCX, TXT, and Markdown files</p>
                </div>

                <!-- Document List -->
                <div class="documents-card">
                    <table class="documents-table">
                        <thead>
                            <tr>
                                <th>Document</th>
                                <th>Size</th>
                                <th>Chunks</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="document-tbody">
                            <tr>
                                <td colspan="4" class="empty-state">No documents uploaded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Stats -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <span class="stat-value" id="doc-count">0</span>
                        <span class="stat-label">Documents</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="chunk-count">0</span>
                        <span class="stat-label">Chunks Indexed</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section class="admin-section">
            <div class="section-header">
                <div class="section-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="section-title-group">
                    <h2 class="section-title">Users</h2>
                    <p class="section-desc">Manage user accounts and permissions</p>
                </div>
                <button class="btn btn-primary" id="add-user-btn" onclick="showAddUserModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Add User
                </button>
            </div>

            <div class="section-body">
                <!-- User List -->
                <div class="documents-card">
                    <table class="documents-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="user-tbody">
                            <tr>
                                <td colspan="6" class="empty-state">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="add-user-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add User</h3>
            <button class="modal-close" onclick="hideAddUserModal()">&times;</button>
        </div>
        <form id="add-user-form" onsubmit="handleAddUser(event)">
            <div class="form-group">
                <label class="form-label" for="new-username">Username</label>
                <input type="text" id="new-username" class="form-input" placeholder="Enter username" required minlength="3">
            </div>
            <div class="form-group">
                <label class="form-label" for="new-password">Password</label>
                <input type="password" id="new-password" class="form-input" placeholder="Enter password" required minlength="6">
            </div>
            <div class="form-group">
                <label class="form-label" for="new-role">Role</label>
                <select id="new-role" class="form-select">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideAddUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="add-user-submit">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" id="reset-password-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Reset Password</h3>
            <button class="modal-close" onclick="hideResetPasswordModal()">&times;</button>
        </div>
        <form id="reset-password-form" onsubmit="handleResetPassword(event)">
            <input type="hidden" id="reset-user-id">
            <p class="modal-info">Resetting password for: <strong id="reset-username"></strong></p>
            <div class="form-group">
                <label class="form-label" for="reset-password">New Password</label>
                <input type="password" id="reset-password" class="form-input" placeholder="Enter new password" required minlength="6">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideResetPasswordModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="reset-password-submit">Reset Password</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>
{% endblock %}

{% block scripts %}
<script>
    // Theme toggle
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('pika_theme', next);
    }

    let pullPollingInterval = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        // Check authentication before loading page content
        // This handles the back-button after logout scenario
        try {
            const authResponse = await fetch('/auth/check');
            const authStatus = await authResponse.json();
            if (authStatus.auth_required && !authStatus.authenticated) {
                // User is not authenticated - redirect to login
                window.location.replace('/admin/login');
                return;
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            // On auth check failure, redirect to login to be safe
            window.location.replace('/admin/login');
            return;
        }

        loadModels();
        loadDocuments();
        loadStats();
        loadUsers();
        setupUpload();
        checkActivePull();

        // Enter key to pull model
        document.getElementById('model-name').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                pullModel();
            }
        });
    });

    // ==================== Models ====================

    async function loadModels() {
        try {
            const response = await fetch('/api/v1/models');
            const models = await response.json();
            const select = document.getElementById('model-select');
            const currentName = document.getElementById('current-model-name');
            const statusBadge = document.getElementById('model-status-badge');
            const statusText = document.getElementById('model-status-text');

            // Find current model
            const current = models.find(m => m.is_current);
            if (current) {
                currentName.textContent = `${current.name} (${current.size})`;
                statusBadge.className = 'status-badge status-active';
                statusText.textContent = 'Running';
            }

            // Populate select
            select.innerHTML = models.map(m => `
                <option value="${m.name}" ${m.is_current ? 'selected' : ''}>
                    ${m.name} (${m.size})
                </option>
            `).join('');

            if (models.length === 0) {
                select.innerHTML = '<option value="">No models available</option>';
                currentName.textContent = 'No model available';
                statusBadge.className = 'status-badge status-inactive';
                statusText.textContent = 'No Model';
            }
        } catch (error) {
            console.error('Failed to load models:', error);
            showToast('Failed to load models', 'error');
        }
    }

    async function switchModel() {
        const select = document.getElementById('model-select');
        const model = select.value;
        if (!model) return;

        const btn = document.getElementById('switch-model-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';

        try {
            const response = await fetch('/api/v1/models/current', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model })
            });

            if (!response.ok) throw new Error('Failed to switch model');

            await loadModels();
            showToast(`Switched to ${model}`, 'success');
        } catch (error) {
            showToast('Failed to switch model', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Switch';
        }
    }

    async function checkActivePull() {
        try {
            const response = await fetch('/api/v1/models/pull/status');
            const status = await response.json();

            if (status.active) {
                // There's an active pull - show progress and start polling
                showPullProgress(status);
                startPullPolling();
            }
        } catch (error) {
            console.error('Failed to check pull status:', error);
        }
    }

    function showPullProgress(status) {
        const btn = document.getElementById('pull-model-btn');
        const progress = document.getElementById('pull-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        btn.disabled = true;
        progress.classList.add('visible');

        if (status.error) {
            progressText.textContent = `Error: ${status.error}`;
            progressFill.style.width = '0%';
        } else if (status.total && status.completed) {
            progressFill.style.width = status.percent + '%';
            progressText.textContent = `Downloading ${status.model}: ${status.percent}%`;
        } else if (status.status) {
            progressText.textContent = `${status.model}: ${status.status}`;
            if (status.status === 'success') {
                progressFill.style.width = '100%';
            }
        }
    }

    function startPullPolling() {
        if (pullPollingInterval) return; // Already polling

        let lastModel = null;

        pullPollingInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/v1/models/pull/status');
                const status = await response.json();

                if (status.active) {
                    lastModel = status.model;
                }

                if (!status.active) {
                    // Pull completed or failed
                    stopPullPolling();
                    const btn = document.getElementById('pull-model-btn');
                    const progress = document.getElementById('pull-progress');

                    btn.disabled = false;
                    await loadModels();

                    if (lastModel) {
                        showToast(`Model ${lastModel} pulled successfully`, 'success');
                    }

                    setTimeout(() => {
                        progress.classList.remove('visible');
                    }, 2000);
                } else {
                    showPullProgress(status);
                }
            } catch (error) {
                console.error('Failed to poll pull status:', error);
            }
        }, 1000);
    }

    function stopPullPolling() {
        if (pullPollingInterval) {
            clearInterval(pullPollingInterval);
            pullPollingInterval = null;
        }
    }

    async function cancelPull() {
        const cancelBtn = document.getElementById('cancel-pull-btn');
        cancelBtn.disabled = true;
        cancelBtn.innerHTML = '<span class="spinner"></span>';

        try {
            const response = await fetch('/api/v1/models/pull/cancel', {
                method: 'POST'
            });

            const result = await response.json();

            stopPullPolling();

            const btn = document.getElementById('pull-model-btn');
            const progress = document.getElementById('pull-progress');

            btn.disabled = false;
            progress.classList.remove('visible');

            if (result.cancelled) {
                showToast('Download cancelled', 'info');
            } else {
                showToast(result.message || 'No active download to cancel', 'info');
            }
        } catch (error) {
            showToast('Failed to cancel download', 'error');
        } finally {
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel';
        }
    }

    async function pullModel() {
        const input = document.getElementById('model-name');
        const modelName = input.value.trim();
        if (!modelName) return;

        // Check if model is already downloaded
        const select = document.getElementById('model-select');
        const existingModels = Array.from(select.options).map(opt => opt.value);

        // Check for exact match or base name match (e.g., "llama3.1:8b" matches "llama3.1:8b")
        const modelExists = existingModels.some(existing => {
            // Exact match
            if (existing === modelName) return true;
            // Match without tag (e.g., "llama3.1" matches "llama3.1:latest")
            const baseName = modelName.split(':')[0];
            const existingBase = existing.split(':')[0];
            return baseName === existingBase && !modelName.includes(':');
        });

        if (modelExists) {
            showToast(`Model "${modelName}" is already downloaded`, 'info');
            return;
        }

        const btn = document.getElementById('pull-model-btn');
        const progress = document.getElementById('pull-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        btn.disabled = true;
        progress.classList.add('visible');
        progressFill.style.width = '0%';
        progressText.textContent = 'Starting download...';

        try {
            const response = await fetch('/api/v1/models/pull', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: modelName })
            });

            const result = await response.json();

            if (!result.started) {
                showToast(result.message, 'error');
                btn.disabled = false;
                progress.classList.remove('visible');
                return;
            }

            input.value = '';
            // Start polling for progress
            startPullPolling();

        } catch (error) {
            showToast(`Failed to pull model: ${error.message}`, 'error');
            btn.disabled = false;
            progress.classList.remove('visible');
        }
    }

    // ==================== Documents ====================

    async function loadDocuments() {
        try {
            const [docsResponse, indexedResponse] = await Promise.all([
                fetch('/documents'),
                fetch('/api/v1/documents')
            ]);

            const documents = await docsResponse.json();
            const indexed = await indexedResponse.json();

            const indexedMap = {};
            indexed.forEach(d => indexedMap[d.filename] = d.chunk_count);

            const tbody = document.getElementById('document-tbody');

            if (documents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">No documents uploaded yet</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = documents.map(doc => `
                <tr>
                    <td class="doc-name" title="${doc.filename}">${doc.filename}</td>
                    <td class="doc-meta">${formatSize(doc.size_bytes)}</td>
                    <td class="doc-meta">${indexedMap[doc.filename] || '—'}</td>
                    <td class="doc-actions">
                        <button class="btn btn-icon btn-danger" onclick="deleteDocument('${doc.filename}')" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Failed to load documents:', error);
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/v1/index/stats');
            const stats = await response.json();
            document.getElementById('doc-count').textContent = stats.total_documents;
            document.getElementById('chunk-count').textContent = stats.total_chunks;
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    async function refreshIndex() {
        const btn = document.getElementById('refresh-index-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Indexing...';

        try {
            const response = await fetch('/api/v1/index', { method: 'POST' });
            const result = await response.json();
            await Promise.all([loadStats(), loadDocuments()]);
            showToast(`Indexed ${result.total_documents} documents (${result.total_chunks} chunks)`, 'success');
        } catch (error) {
            showToast('Failed to refresh index', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                Refresh Index
            `;
        }
    }

    function setupUpload() {
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
            fileInput.value = '';
        });
    }

    async function handleFiles(files) {
        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                showToast(`Uploaded: ${file.name}`, 'success');
            } catch (error) {
                showToast(`Failed to upload ${file.name}`, 'error');
            }
        }
        await loadDocuments();
    }

    async function deleteDocument(filename) {
        if (!confirm(`Delete "${filename}"?`)) return;

        try {
            const response = await fetch(`/documents/${encodeURIComponent(filename)}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Delete failed');

            showToast(`Deleted: ${filename}`, 'success');
            await loadDocuments();
        } catch (error) {
            showToast('Failed to delete file', 'error');
        }
    }

    // ==================== Utilities ====================

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ==================== Users ====================

    async function loadUsers() {
        try {
            const response = await fetch('/api/v1/users');
            if (!response.ok) {
                if (response.status === 403) {
                    // User doesn't have admin access, hide the section
                    const section = document.querySelector('.admin-section:has(#user-tbody)');
                    if (section) section.style.display = 'none';
                    return;
                }
                throw new Error('Failed to load users');
            }
            const users = await response.json();
            const tbody = document.getElementById('user-tbody');

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">No users found</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr data-user-id="${user.id}">
                    <td class="doc-name">${escapeHtml(user.username)}</td>
                    <td class="doc-meta">
                        <span class="role-badge role-${user.role}">${user.role}</span>
                    </td>
                    <td class="doc-meta">
                        <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                            <span class="status-dot"></span>
                            ${user.is_active ? 'Active' : 'Disabled'}
                        </span>
                    </td>
                    <td class="doc-meta">${formatDate(user.created_at)}</td>
                    <td class="doc-meta">${user.last_login ? formatDate(user.last_login) : '—'}</td>
                    <td class="doc-actions user-actions">
                        <button class="btn btn-icon btn-secondary" onclick="showResetPasswordModal(${user.id}, '${escapeHtml(user.username)}')" title="Reset Password">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </button>
                        <button class="btn btn-icon ${user.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleUser(${user.id})" title="${user.is_active ? 'Disable' : 'Enable'}">
                            ${user.is_active ? `
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                </svg>
                            ` : `
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            `}
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Failed to load users:', error);
            const tbody = document.getElementById('user-tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">Failed to load users</td>
                </tr>
            `;
        }
    }

    function showAddUserModal() {
        document.getElementById('add-user-modal').classList.add('visible');
        document.getElementById('new-username').focus();
    }

    function hideAddUserModal() {
        document.getElementById('add-user-modal').classList.remove('visible');
        document.getElementById('add-user-form').reset();
    }

    async function handleAddUser(event) {
        event.preventDefault();
        const btn = document.getElementById('add-user-submit');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';

        const username = document.getElementById('new-username').value;
        const password = document.getElementById('new-password').value;
        const role = document.getElementById('new-role').value;

        try {
            const response = await fetch('/api/v1/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to create user');
            }

            hideAddUserModal();
            await loadUsers();
            showToast(`User "${username}" created successfully`, 'success');
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Create User';
        }
    }

    function showResetPasswordModal(userId, username) {
        document.getElementById('reset-user-id').value = userId;
        document.getElementById('reset-username').textContent = username;
        document.getElementById('reset-password-modal').classList.add('visible');
        document.getElementById('reset-password').focus();
    }

    function hideResetPasswordModal() {
        document.getElementById('reset-password-modal').classList.remove('visible');
        document.getElementById('reset-password-form').reset();
    }

    async function handleResetPassword(event) {
        event.preventDefault();
        const btn = document.getElementById('reset-password-submit');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';

        const userId = document.getElementById('reset-user-id').value;
        const password = document.getElementById('reset-password').value;

        try {
            const response = await fetch(`/api/v1/users/${userId}/password`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to reset password');
            }

            hideResetPasswordModal();
            showToast('Password reset successfully', 'success');
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Reset Password';
        }
    }

    async function toggleUser(userId) {
        try {
            const response = await fetch(`/api/v1/users/${userId}/toggle`, {
                method: 'PUT'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to toggle user status');
            }

            const result = await response.json();
            await loadUsers();
            showToast(`User ${result.is_active ? 'enabled' : 'disabled'} successfully`, 'success');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function deleteUser(userId, username) {
        if (!confirm(`Delete user "${username}"? This action cannot be undone.`)) return;

        try {
            const response = await fetch(`/api/v1/users/${userId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete user');
            }

            await loadUsers();
            showToast(`User "${username}" deleted successfully`, 'success');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function formatDate(isoString) {
        if (!isoString) return '—';
        const date = new Date(isoString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
